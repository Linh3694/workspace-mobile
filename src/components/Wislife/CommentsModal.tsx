import React, { useState } from 'react';
// @ts-ignore
import { View, Text, Modal, TouchableOpacity, ScrollView, TextInput, Image, ActivityIndicator, Alert, KeyboardAvoidingView, Platform } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Post, Comment, Reaction } from '../../types/post';
import { postService } from '../../services/postService';
import { useAuth } from '../../context/AuthContext';
import { getAvatar } from '../../utils/avatar';
import { formatRelativeTime } from '../../utils/dateUtils';
import { useEmojis, CustomEmoji } from '../../hooks/useEmojis';
import EmojiReactionModal from './EmojiReactionModal';
import LikeSkeletonSvg from '../../assets/like-skeleton.svg';

interface CommentsModalProps {
  visible: boolean;
  onClose: () => void;
  post: Post;
  onUpdate: (post: Post) => void;
}

// Type for emoji data that can be either custom or fallback
type EmojiData = CustomEmoji | {
  code: string;
  url: null;
  fallbackText: string;
};

// Gradient Text Component ƒë∆°n gi·∫£n
const GradientText: React.FC<{ children: string; style?: any }> = ({ children, style }) => {
  return (
    <Text style={[{ fontSize: 16, fontWeight: '500', color: '#F05023' }, style]}>
      {children}
    </Text>
  );
};

const CommentsModal: React.FC<CommentsModalProps> = ({
  visible,
  onClose,
  post,
  onUpdate,
}) => {
  const { user } = useAuth();
  const { customEmojis } = useEmojis();
  const [commentText, setCommentText] = useState('');
  const [loading, setLoading] = useState(false);
  const [emojiModalVisible, setEmojiModalVisible] = useState(false);
  const [reactionButtonPosition, setReactionButtonPosition] = useState<{ x: number; y: number } | undefined>(undefined);
  const reactionsRef = React.useRef<View>(null);
  const likeButtonRef = React.useRef<View>(null);
  const [replyingTo, setReplyingTo] = useState<string | null>(null);
  const [likingComment, setLikingComment] = useState<string | null>(null);
  const [commentReactionModalVisible, setCommentReactionModalVisible] = useState(false);
  const [selectedCommentId, setSelectedCommentId] = useState<string | null>(null);

  // S·∫Øp x·∫øp comments t·ª´ m·ªõi nh·∫•t ƒë·∫øn c≈© nh·∫•t v√† nh√≥m replies
  const organizeComments = () => {
    // T√°ch main comments v√† replies
    const mainComments = post.comments.filter(comment => !comment.parentComment);
    const replies = post.comments.filter(comment => comment.parentComment);
    
    // Sort main comments t·ª´ m·ªõi ƒë·∫øn c≈©
    const sortedMainComments = [...mainComments].sort((a, b) => 
      new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
    );
    
    // T·∫°o c·∫•u tr√∫c comments v·ªõi replies
    return sortedMainComments.map(mainComment => ({
      ...mainComment,
      replies: replies
        .filter(reply => reply.parentComment === mainComment._id)
        .sort((a, b) => new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()) // replies sort c≈© ƒë·∫øn m·ªõi
    }));
  };

  const organizedComments = organizeComments();

  const getUserReaction = (): Reaction | null => {
    return post.reactions.find(reaction => reaction.user._id === user?._id) || null;
  };

  const getReactionCounts = () => {
    const counts: Record<string, number> = {};
    
    post.reactions.forEach(reaction => {
      counts[reaction.type] = (counts[reaction.type] || 0) + 1;
    });

    return counts;
  };

  const getEmojiByCode = (code: string): EmojiData => {
    const emoji = customEmojis.find(emoji => emoji.code === code);
    
    // Fallback cho c√°c emoji codes c≈© ho·∫∑c kh√¥ng t·ªìn t·∫°i
    if (!emoji) {
      // Map legacy reaction types to emoji text
      const legacyEmojiMap: Record<string, string> = {
        'like': 'üëç',
        'love': '‚ù§Ô∏è',
        'haha': 'üòÇ',
        'sad': 'üò¢',
        'wow': 'üòÆ'
      };
      
      return {
        code,
        url: null,
        fallbackText: legacyEmojiMap[code] || 'üëç'
      };
    }
    
    return emoji;
  };

  // Type guard function
  const isFallbackEmoji = (emoji: EmojiData): emoji is { code: string; url: null; fallbackText: string } => {
    return emoji.url === null && 'fallbackText' in emoji;
  };

  const handleReaction = async (emojiCode: string) => {
    // ƒê√≥ng modal ngay l·∫≠p t·ª©c khi ch·ªçn emoji
    setEmojiModalVisible(false);
    
    try {
      const userReaction = getUserReaction();
      
      let updatedPost: Post;
      if (userReaction) {
        if (userReaction.type === emojiCode) {
          // Remove reaction if same type
          updatedPost = await postService.removeReaction(post._id);
        } else {
          // Change reaction type
          updatedPost = await postService.addReaction(post._id, emojiCode);
        }
      } else {
        // Add new reaction
        updatedPost = await postService.addReaction(post._id, emojiCode);
      }
      
      onUpdate(updatedPost);
    } catch (error) {
      console.error('Error handling reaction:', error);
      Alert.alert('L·ªói', 'Kh√¥ng th·ªÉ th·ª±c hi·ªán reaction. Vui l√≤ng th·ª≠ l·∫°i.');
    }
  };

  const handleLikeButtonPress = () => {
    // N·∫øu modal ƒëang m·ªü th√¨ ƒë√≥ng l·∫°i
    if (emojiModalVisible) {
      setEmojiModalVisible(false);
      return;
    }
    // ƒêo v·ªã tr√≠ c·ªßa like button v√† hi·ªÉn th·ªã modal ngay d∆∞·ªõi ƒë√≥
    if (likeButtonRef.current) {
      likeButtonRef.current.measureInWindow((x, y, width, height) => {
        setReactionButtonPosition({ x: x, y: y + height + 10 });
        setEmojiModalVisible(true);
      });
    } else {
      setEmojiModalVisible(true);
    }
  };

  const handleCloseEmojiModal = () => {
    setEmojiModalVisible(false);
  };

  const handleLikeComment = async (commentId: string) => {
    try {
      setLikingComment(commentId);
      
      // Ki·ªÉm tra xem user ƒë√£ like comment n√†y ch∆∞a
      const comment = post.comments.find(c => c._id === commentId);
      if (!comment) return;
      
      const userReaction = comment.reactions.find(r => r.user._id === user?._id);
      
      let updatedPost: Post;
      if (userReaction) {
        // User ƒë√£ like, remove reaction
        updatedPost = await postService.removeCommentReaction(post._id, commentId);
      } else {
        // User ch∆∞a like, add reaction v·ªõi type 'like'
        updatedPost = await postService.addCommentReaction(post._id, commentId, 'like');
      }
      
      onUpdate(updatedPost);
    } catch (error) {
      console.error('Error liking comment:', error);
      Alert.alert('L·ªói', 'Kh√¥ng th·ªÉ th√≠ch b√¨nh lu·∫≠n. Vui l√≤ng th·ª≠ l·∫°i.');
    } finally {
      setLikingComment(null);
    }
  };

  const handleCommentReaction = (commentId: string) => {
    setSelectedCommentId(commentId);
    setCommentReactionModalVisible(true);
  };

  const handleCommentReactionSelect = async (commentId: string, emojiCode: string) => {
    try {
      setCommentReactionModalVisible(false);
      
      // Ki·ªÉm tra xem user ƒë√£ c√≥ reaction lo·∫°i n√†y ch∆∞a
      const comment = post.comments.find(c => c._id === commentId);
      if (!comment) return;
      
      const userReaction = comment.reactions.find(r => r.user._id === user?._id);
      
      let updatedPost: Post;
      if (userReaction && userReaction.type === emojiCode) {
        // C√πng lo·∫°i reaction, remove it
        updatedPost = await postService.removeCommentReaction(post._id, commentId);
      } else {
        // Kh√°c lo·∫°i ho·∫∑c ch∆∞a c√≥ reaction, add/update reaction
        updatedPost = await postService.addCommentReaction(post._id, commentId, emojiCode);
      }
      
      onUpdate(updatedPost);
    } catch (error) {
      console.error('Error adding comment reaction:', error);
      Alert.alert('L·ªói', 'Kh√¥ng th·ªÉ th√™m reaction. Vui l√≤ng th·ª≠ l·∫°i.');
    }
  };

  const handleReplyComment = (commentId: string, commentAuthor: string) => {
    setReplyingTo(commentId);
    setCommentText(`@${commentAuthor} `);
  };

  const handleCancelReply = () => {
    setReplyingTo(null);
    setCommentText('');
  };

  const handleComment = async () => {
    if (!commentText.trim()) return;

    try {
      setLoading(true);
      if (replyingTo) {
        // X·ª≠ l√Ω reply comment
        const cleanContent = commentText.trim();
        const updatedPost = await postService.replyComment(post._id, replyingTo, cleanContent);
        onUpdate(updatedPost);
      } else {
        // X·ª≠ l√Ω comment th√¥ng th∆∞·ªùng
        const updatedPost = await postService.addComment(post._id, commentText.trim());
        onUpdate(updatedPost);
      }
      setCommentText('');
      setReplyingTo(null);
    } catch (error) {
      console.error('Error adding comment:', error);
      Alert.alert('L·ªói', 'Kh√¥ng th·ªÉ th√™m b√¨nh lu·∫≠n. Vui l√≤ng th·ª≠ l·∫°i.');
    } finally {
      setLoading(false);
    }
  };

  const reactionCounts = getReactionCounts();
  const userReaction = getUserReaction();
  const totalReactions = post.reactions.length;

  const renderCommentContent = (content: string) => {
    // T√°ch text th√†nh c√°c ph·∫ßn ƒë·ªÉ highlight @mentions
    // Ch·ªâ match t√™n ng∆∞·ªùi th·∫≠t: @ + t·ª´ ƒë·∫ßu vi·∫øt hoa + t·ªëi ƒëa 2 t·ª´ ti·∫øp theo c≈©ng vi·∫øt hoa
    const parts = content.split(/(@[A-Z√Ä√Å·∫¢√É·∫†ƒÇ·∫Æ·∫∞·∫≤·∫¥·∫∂√Ç·∫§·∫¶·∫®·∫™·∫¨ƒê√à√â·∫∫·∫º·∫∏√ä·∫æ·ªÄ·ªÇ·ªÑ·ªÜ√å√ç·ªàƒ®·ªä√í√ì·ªé√ï·ªå√î·ªê·ªí·ªî·ªñ·ªò∆†·ªö·ªú·ªû·ª†·ª¢√ô√ö·ª¶≈®·ª§∆Ø·ª®·ª™·ª¨·ªÆ·ª∞·ª≤√ù·ª∂·ª∏·ª¥][a-z√†√°·∫£√£·∫°ƒÉ·∫Ø·∫±·∫≥·∫µ·∫∑√¢·∫•·∫ß·∫©·∫´·∫≠ƒë√®√©·∫ª·∫Ω·∫π√™·∫ø·ªÅ·ªÉ·ªÖ·ªá√¨√≠·ªâƒ©·ªã√≤√≥·ªè√µ·ªç√¥·ªë·ªì·ªï·ªó·ªô∆°·ªõ·ªù·ªü·ª°·ª£√π√∫·ªß≈©·ª•∆∞·ª©·ª´·ª≠·ªØ·ª±·ª≥√Ω·ª∑·ªπ·ªµ]*(?:\s+[A-Z√Ä√Å·∫¢√É·∫†ƒÇ·∫Æ·∫∞·∫≤·∫¥·∫∂√Ç·∫§·∫¶·∫®·∫™·∫¨ƒê√à√â·∫∫·∫º·∫∏√ä·∫æ·ªÄ·ªÇ·ªÑ·ªÜ√å√ç·ªàƒ®·ªä√í√ì·ªé√ï·ªå√î·ªê·ªí·ªî·ªñ·ªò∆†·ªö·ªú·ªû·ª†·ª¢√ô√ö·ª¶≈®·ª§∆Ø·ª®·ª™·ª¨·ªÆ·ª∞·ª≤√ù·ª∂·ª∏·ª¥][a-z√†√°·∫£√£·∫°ƒÉ·∫Ø·∫±·∫≥·∫µ·∫∑√¢·∫•·∫ß·∫©·∫´·∫≠ƒë√®√©·∫ª·∫Ω·∫π√™·∫ø·ªÅ·ªÉ·ªÖ·ªá√¨√≠·ªâƒ©·ªã√≤√≥·ªè√µ·ªç√¥·ªë·ªì·ªï·ªó·ªô∆°·ªõ·ªù·ªü·ª°·ª£√π√∫·ªß≈©·ª•∆∞·ª©·ª´·ª≠·ªØ·ª±·ª≥√Ω·ª∑·ªπ·ªµ]*){0,2})/g);
    
    return (
      <Text className="text-gray-800 text-base leading-5">
        {parts.map((part, index) => {
          if (part.startsWith('@') && part.trim().length > 1) {
            return (
              <Text key={index} className="text-blue-500 font-medium">
                {part.trim()}
              </Text>
            );
          }
          return part;
        })}
      </Text>
    );
  };

  const getUniqueReactionTypes = (reactions: Reaction[]): string[] => {
    const types: string[] = [];
    reactions.forEach(reaction => {
      if (!types.includes(reaction.type)) {
        types.push(reaction.type);
      }
    });
    return types;
  };

  return (
    <Modal
      visible={visible}
      animationType="slide"
      presentationStyle="pageSheet"
      onRequestClose={onClose}
    >
      <SafeAreaView className="flex-1 bg-white">
        {/* Reactions Section */}
        {totalReactions > 0 && (
          <View className="px-4 py-3" ref={reactionsRef}>
            <View className="flex-row items-center justify-between">
              <View className="flex-row items-center flex-1">
                <View className="flex-row">
                  {Object.entries(reactionCounts).map(([emojiCode, count]) => {
                    const emoji = getEmojiByCode(emojiCode);
                    if (!emoji || count === 0) return null;
                    return (
                      <View key={emojiCode}>
                        {emoji.url ? (
                          <Image
                            source={emoji.url}
                            className="w-8 h-8"
                            resizeMode="contain"
                          />
                        ) : isFallbackEmoji(emoji) ? (
                          <Text className="text-sm font-medium">{emoji.fallbackText}</Text>
                        ) : (
                          <Text className="text-sm font-medium">üëç</Text>
                        )}
                      </View>
                    );
                  })}
                </View>
                <Text className="text-base font-semibold text-[#757575] ml-2">
                  {totalReactions === 1 
                    ? (userReaction ? 'B·∫°n' : '1 ng∆∞·ªùi')
                    : userReaction 
                      ? `B·∫°n v√† ${totalReactions - 1} ng∆∞·ªùi kh√°c` 
                      : `${totalReactions} ng∆∞·ªùi kh√°c`}
                </Text>
              </View>
              {/* Reaction Button */}
              <TouchableOpacity
                onPress={handleLikeButtonPress}
                className="flex-row items-center px-3 py-2 rounded-full mr-5"
                ref={likeButtonRef}
              >
                {userReaction ? (
                  <>
                    {(() => {
                      const emoji = getEmojiByCode(userReaction.type);
                      if (emoji && emoji.url) {
                        return (
                          <Image
                            source={emoji.url}
                            className="w-8 h-8 mr-1"
                            resizeMode="contain"
                          />
                        );
                      } else if (emoji && isFallbackEmoji(emoji)) {
                        return (
                          <Text className="text-lg mr-1 font-semibold">{emoji.fallbackText}</Text>
                        );
                      } else {
                        return (
                          <LikeSkeletonSvg width={24} height={24} />
                        );
                      }
                    })()}
                    
                    <GradientText style={{ fontSize: 13 }}>
                      Th√≠ch
                    </GradientText>
                  </>
                ) : (
                  <>
                    <LikeSkeletonSvg width={32} height={32} />
                  </>
                )}
              </TouchableOpacity>
            </View>
          </View>
        )}

        <KeyboardAvoidingView 
          className="flex-1"
          behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
          keyboardVerticalOffset={Platform.OS === 'ios' ? 60 : 60}
        >
          {/* Comments List */}
          <ScrollView className="flex-1 px-4">
            {post.comments.length === 0 ? (
              <View className="flex-1 items-center justify-center py-10">
                <Ionicons name="chatbubble-outline" size={64} color="#D1D5DB" />
                <Text className="mt-4 text-lg font-medium text-gray-500">
                  Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o
                </Text>
                <Text className="mt-2 text-gray-400 text-center px-8">
                  H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n b√¨nh lu·∫≠n v·ªÅ b√†i vi·∫øt n√†y
                </Text>
              </View>
            ) : (
              <View>
                {organizedComments.map((comment) => (
                  <View key={comment._id} className="mb-6">
                    <View className="flex-row">
                      <View className="w-10 h-10 rounded-full overflow-hidden mr-1">
                        <Image 
                          source={{ uri: getAvatar(comment.user) }} 
                          className="w-full h-full"
                        />
                      </View>
                      <View className="flex-1">
                        <View className="rounded-2xl px-4">
                            <View className="flex-row items-center justify-start gap-2">
                          <Text className="font-semibold text-base text-gray-900 mb-1">
                            {comment.user.fullname}
                         </Text>
                            <Text className="text-sm text-gray-500">
                              {formatRelativeTime(comment.createdAt)}
                                        </Text>
                                        </View>
                          {renderCommentContent(comment.content)}
                        </View>
                        
                        {/* Actions v√† Reactions tr√™n c√πng m·ªôt h√†ng */}
                        <View className="flex-row items-center justify-between mt-2">
                          {/* B√™n tr√°i: Time v√† Action buttons */}
                          <View className="flex-row items-center flex-1">
                           
                            <TouchableOpacity 
                              className="ml-4"
                              onPress={() => handleCommentReaction(comment._id)}
                              disabled={likingComment === comment._id}
                            >
                              <Text className={`text-sm font-bold ${
                                comment.reactions.some(r => r.user._id === user?._id) 
                                  ? 'text-orange-500' 
                                  : 'text-gray-600'
                              }`}>
                                {likingComment === comment._id ? 'ƒêang x·ª≠ l√Ω...' : 
                                 comment.reactions.some(r => r.user._id === user?._id) ? 'ƒê√£ th√≠ch' : 'Th√≠ch'}
                              </Text>
                            </TouchableOpacity>
                            
                            <TouchableOpacity 
                              className="ml-4"
                              onPress={() => handleReplyComment(comment._id, comment.user.fullname)}
                            >
                              <Text className="text-sm text-gray-600 font-bold">
                                Tr·∫£ l·ªùi
                              </Text>
                            </TouchableOpacity>
                          </View>

                          {/* B√™n ph·∫£i: Comment Reactions */}
                          {comment.reactions.length > 0 && (
                            <View className="flex-row items-center">
                                            <View className="flex-row items-center px-2 py-1">
                                                 <Text className="text-sm text-gray-600 mr-1">
                                  {comment.reactions.length}
                                </Text>
                                {getUniqueReactionTypes(comment.reactions).map((reactionType) => {
                                  const emoji = getEmojiByCode(reactionType);
                                  return (
                                    <View key={reactionType} className="mr-1">
                                      {emoji.url ? (
                                        <Image
                                          source={emoji.url}
                                          className="w-6 h-6"
                                          resizeMode="contain"
                                        />
                                      ) : isFallbackEmoji(emoji) ? (
                                        <Text className="text-base">{emoji.fallbackText}</Text>
                                      ) : (
                                        <Text className="text-base">üëç</Text>
                                      )}
                                    </View>
                                  );
                                })}
                               
                              </View>
                            </View>
                          )}
                        </View>

                        {/* Hi·ªÉn th·ªã replies */}
                        {comment.replies && comment.replies.length > 0 && (
                          <View className="ml-6 mt-4">
                            {comment.replies.map((reply) => (
                              <View key={reply._id} className="mb-4">
                                <View className="flex-row">
                                  <View className="w-8 h-8 rounded-full overflow-hidden bg-gray-300 mr-3">
                                    <Image 
                                      source={{ uri: getAvatar(reply.user) }} 
                                      className="w-full h-full"
                                    />
                                  </View>
                                  <View className="flex-1">
                                            <View>
                                                <View className="flex-row items-center justify-start gap-2">
                                      <Text className="font-semibold text-sm text-gray-900 mb-1">
                                        {reply.user.fullname}
                                                </Text>
                                                 <Text className="text-xs text-gray-500 font-medium">
                                          {formatRelativeTime(reply.createdAt)}
                                                    </Text>
                                                    </View>
                                      {renderCommentContent(reply.content)}
                                    </View>
                                    
                                    {/* Actions v√† Reactions cho reply tr√™n c√πng m·ªôt h√†ng */}
                                    <View className="flex-row items-center justify-between mt-1">
                                      {/* B√™n tr√°i: Time v√† Action buttons */}
                                      <View className="flex-row items-center flex-1">
                                       
                                        
                                        <TouchableOpacity 
                                          className="ml-1"
                                          onPress={() => handleCommentReaction(reply._id)}
                                        >
                                          <Text className={`text-xs font-medium ${
                                            reply.reactions.some(r => r.user._id === user?._id) 
                                              ? 'text-orange-500' 
                                              : 'text-gray-600'
                                          }`}>
                                            {reply.reactions.some(r => r.user._id === user?._id) ? 'ƒê√£ th√≠ch' : 'Th√≠ch'}
                                          </Text>
                                        </TouchableOpacity>
                                        
                                        <TouchableOpacity 
                                          className="ml-3"
                                          onPress={() => handleReplyComment(comment._id, reply.user.fullname)}
                                        >
                                          <Text className="text-xs text-gray-600 font-medium">
                                            Tr·∫£ l·ªùi
                                          </Text>
                                        </TouchableOpacity>
                                      </View>

                                      {/* B√™n ph·∫£i: Reply Reactions */}
                                      {reply.reactions.length > 0 && (
                                        <View className="flex-row items-center">
                                                        <View className="flex-row items-center ">
                                                            <Text className="text-sm text-gray-600 mr-1">
                                              {reply.reactions.length}
                                            </Text>
                                            {getUniqueReactionTypes(reply.reactions).map((reactionType) => {
                                              const emoji = getEmojiByCode(reactionType);
                                              return (
                                                <View key={reactionType} className="mr-1">
                                                  {emoji.url ? (
                                                    <Image
                                                      source={emoji.url}
                                                      className="w-6 h-6"
                                                      resizeMode="contain"
                                                    />
                                                  ) : isFallbackEmoji(emoji) ? (
                                                    <Text className="text-sm">{emoji.fallbackText}</Text>
                                                  ) : (
                                                    <Text className="text-sm">üëç</Text>
                                                  )}
                                                </View>
                                              );
                                            })}
                                            
                                          </View>
                                        </View>
                                      )}
                                    </View>
                                  </View>
                                </View>
                              </View>
                            ))}
                          </View>
                        )}
                      </View>
                    </View>
                  </View>
                ))}
              </View>
            )}
          </ScrollView>

          {/* Comment Input */}
          <View className="px-4 py-3 border-t border-gray-200 bg-white">
            {/* Reply indicator */}
            {replyingTo && (
              <View className="flex-row items-center justify-between mb-2 p-2 bg-gray-50 rounded-lg">
                <View className="flex-1">
                  <Text className="text-sm text-gray-600">
                    ƒêang tr·∫£ l·ªùi{' '}
                    <Text className="font-semibold text-gray-800">
                      {(() => {
                        const replyTarget = organizedComments.find(c => c._id === replyingTo);
                        if (replyTarget) return replyTarget.user.fullname;
                        
                        // T√¨m trong replies n·∫øu kh√¥ng t√¨m th·∫•y trong main comments
                        for (const comment of organizedComments) {
                          const reply = comment.replies?.find(r => r._id === replyingTo);
                          if (reply) return reply.user.fullname;
                        }
                        return 'comment';
                      })()}
                    </Text>
                  </Text>
                </View>
                <TouchableOpacity onPress={handleCancelReply}>
                  <Ionicons name="close" size={16} color="#6B7280" />
                </TouchableOpacity>
              </View>
            )}
            
            <View className="flex-row items-center">
              <View className="w-10 h-10 rounded-full overflow-hidden bg-gray-300 mr-3">
                <Image 
                  source={{ uri: getAvatar(user) }} 
                  className="w-full h-full"
                />
              </View>
              <View className="flex-1 flex-row items-center bg-gray-100 rounded-full px-4 py-3">
                <TextInput
                  className="flex-1 text-base"
                  placeholder="Nh·∫≠p tin nh·∫Øn..."
                  placeholderTextColor="#9CA3AF"
                  value={commentText}
                  onChangeText={setCommentText}
                  multiline
                  textAlignVertical="center"
                  style={{ 
                    minHeight: 24,
                    maxHeight: 100,
                    textAlign: 'left',
                    paddingTop: 0,
                    paddingBottom: 0
                  }}
                />
                <TouchableOpacity
                  onPress={handleComment}
                  disabled={!commentText.trim() || loading}
                  className={`ml-2 p-1 ${
                    commentText.trim() && !loading ? 'opacity-100' : 'opacity-50'
                  }`}
                >
                  {loading ? (
                    <ActivityIndicator size="small" color="#FF7A00" />
                  ) : (
                    <Ionicons name="send" size={20} color="#FF7A00" />
                  )}
                </TouchableOpacity>
              </View>
            </View>
          </View>
        </KeyboardAvoidingView>
      </SafeAreaView>

      {/* Emoji Reaction Modal */}
      <EmojiReactionModal
        visible={emojiModalVisible}
        onClose={handleCloseEmojiModal}
        onEmojiSelect={handleReaction}
        position={reactionButtonPosition}
      />

      {/* Comment Reaction Modal */}
      <EmojiReactionModal
        visible={commentReactionModalVisible}
        onClose={() => setCommentReactionModalVisible(false)}
        onEmojiSelect={(emojiCode) => selectedCommentId && handleCommentReactionSelect(selectedCommentId, emojiCode)}
        position={undefined}
      />
    </Modal>
  );
};

export default CommentsModal; 